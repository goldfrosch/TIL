# 전송 계층

송신자와 수신자를 연결하는 통신 서비스를 제공하는 계층으로, 데이터 전달을 담당
이 계층의 프로토콜은 애플리케이션에 대한 서로간의 통신 서비스를 제공해준다.

사용하는 프로토콜은 TCP, UDP로 각각의 장단점을 가지고 있다.

## TCP

Transmission Control Protocol의 줄임말로, 전송, 송신 통신을 제어하는 연결 지향의 신뢰성있는 전송 프로토콜이라고도 한다.

프로세스 사이의 프로토콜이며 데이터를 전송하기 위해 두개의 TCP 간에 가상 연결을 설정함으로써 전송 단계에서 흐름을 제어하고 오류 제어 메커니즘을 사용하게 된다.

### 동작 원리

인터넷을 통해 작은 데이터 패킷을 전송해 수신기에 도착하면 재조립하는 방식으로 동작하게 된다.

1. TCP는 각 데이터 패킷에 고유 식별자와 seq를 부여해 수신자가 어떤 패킷이 수신되고, 도착할지를 식별 가능하다.
2. 데이터 패킷이 수신되고 올바른 순서로 도착하게 되면 수신자는 발신자에게 수신 확인을 보낸다.
3. 발신자는 다시 새로운 패킷 전송이 가능해진다.
4. 패킷 분실 or 순서 미스가 날 경우 수신자는 동일한 데이터 패킷을 다시 보내야함을 알리는 침묵 상태를 유지하게 된다.

데이터가 순차적으로 전송되기 때문에 데이터 혼잡과 흐름 제어에 도움이 되고 오류 발견이 쉽다.

다만 TCP는 데이터 전송을 위해 많은 통신이 오가기 때문에 연결 설정(3-way-hand-shaking, 4-way-hand-shaking)과 데이터 교환에 시간이 오래걸린다.

#### 3-way-hand-shaking

TCP/IP 프로토콜을 이용해 통신을 하는 어플리케이션이 데이터 전송 전 먼저 정확한 전송을 보장하기 위해 상대 어플리케이션과 사전에 세션을 수립하는 과정 (연결 초기화)

과정: Sender > Receiver : TCP SYN / Receiver > Sender : TCP SYN ACK / Sender > Receiver : TCP ACK

SYN -> synchronize sequence numbers(패킷 고유 seq), ACK -> acknowledgment(확인 응답)

##### 동작 플로우

1. 발신자에서 TCP를 통해 식별자 패킷(SYN)을 보낸 후 SYN/ACK정보 응답을 기다리는 SYN_SENT 상태가 된다.
2. 수신자에서 SYN 요청을 받고 발신자에게 요청을 수락한다는 ACK 정보와 SYN flag가 설정된 패킷을 발송 후 발신자가 다시 ACK로 응답하기를 기다린다. (수신자는 SYN_RECEIVED 즉 SYN을 받은 상태가 된다)
3. 발신자가 ACK 정보를 다시 보내줌으로써 연결이 이루어지고 데이터가 오가게 될 수 있게 된다. (수신자의 상태가 ESTABLISHED(정착 완료)가 된다.)

#### 4-way-hand-shaking

세션을 종료하기 위해 수행되는 절차를 진행할 때 4번의 과정 즉 4-hand-shaking이 발생한다.

과정: Sender > Receiver : TCP FIN / Receiver > Sender : TCP ACK / Receiver > Sender : TCP FIN / Sender > Receiver : TCP ACK

FIN -> FIN(연결 종료 플래그), ACK -> acknowledgment(확인 응답)

##### 동작 플로우

1. 발신자가 연결 종료 FIN 플래그를 전송한다.
2. 수신자는 확인 메세지를 보내고 통신이 끝날 때 까지 기다린다. (TIME_WAIT 상태가 된다)
3. 수신자가 연결 종료되었다고 발신자에게 다시 FIN 플래그를 전송한다.
4. 발신자가 확인했다는 메세지를 보내 연결을 종료한다.

수신자가 FIN을 전송하기 전에 전송한 패킷이 Routing 지연 이슈 혹은 패킷 유실로 인한 재전송으로 인해 FIN 플래그 패킷보다 늦게 도착하는 상황이 되어버리면 이 패킷이 drop되고 데이터가 유실될 수 있어 발신자는 수신자로부터 FIN 플래그를 수신하더라도 일정 시간(기본 240초)동안 세션을 유지시키고 잉여 패킷을 기다리는 과정을 거치게 되는데 이 상태가 TIME_WAIT이라고 한다.

즉 종료 플래그를 보내도 바로 종료되는 것은 아니라는 것

## UDP

User Datagram Protocol 즉 사용자 데이터그램 프로토콜의 약자로 TCP에 비해 안정성은 떨어지나 빠르고 간단해 실시간 스트리밍이나 게임과 같이 빠른 속도가 중요한 애플리케이션에서 활용된다.

### 동작 원리

TCP랑은 다르게 고유 식별자나 seq가 없이 TCP와 동일한 작업을 수행하는 방식으로 작동한다. 스트림으로 데이터를 전송하고 데이터가 손상되지 않고 잘 도착했는지만 확인하는 checksum만 존재한다.

UDP는 오류 수정이 거의 없고, 패킷 손실에 대해서도 신경쓰지 않아 오류가 발생하기 쉽지만 TCP처럼 전송을 위해 서로간의 여러번 통신이 필요없이 한번에 처리되니 매우 빠르다.

데이터 전송에 대해 초점을 맞추고 설계되어 있어 전송 header에 들어있는게 별로없다.

### HTTP 3.0

HTTP 3.0 부터는 TCP가 아닌 UDP 통신으로 변경되었고 2022년 11월 15일 한국에서 최초로 네이버에서 HTTP/3을 도입하면서 UDP를 사용하게 되었다

### UDP 개선안

UDP는 신뢰성 대신 속도를 택했고, 신뢰성이 없는 것이 아닌 신뢰성 보장의 정보를 탑재하지 않은 것 뿐이다. UDP를 사용한 스트리밍은 영상이 중간에 끊기더라도 데이터를 빠르게 송출하는 것이 더 중요해 속도만을 택하였고 인터넷은 클라이언트와 서버 간의 정확한 패킷 통신이 필요하기 때문에 신뢰성이 보장받아야해서 TCP를 도입했던 것이다.

UDP는 신뢰성이 없어 사용성이 적다고 이해하고 있으나 탑재를 안한 것 뿐이고 UDP는 커스터마이징이 가능해 개발자가 어떻게 구현하느냐에 따라 TCP와 비슷한 수준의 기능을 가지더라도 빠르게 쓸 수 있다.

### QUIC 프로토콜

UDP를 개조한 프로토콜로 Quick UDP Internet Connections의 약자다.

UDP를 기반으로 TCP + TLS(보안 통신 프로토콜) + HTTP의 기능을 모두 구현하는 프로토콜로 HTTP 3.0은 UDP를 도입한 것이 아닌 정확하게는 이 QUIC를 도입하였다.

QUIC는 TCP를 사용하지 않아 통신 시작 시 3-way-hand-shake 과정을 필요로 하지 않는다.

발신자가 보낸 요청을 수신자가 처리한 후 다시 발신자로 응답해주는 사이클 자체를 RTT(Round Trip Time)이라고 부르는데 TCP는 연결을 생성하기 위해 1RTT가 필요하고 TLS를 사용한 암호화까지 하려할 때 TLS의 자체 핸드쉐이크까지 더해져 총 3RTT를 필요로 하게 된다.

하지만 QUIC를 사용하게 되면 첫 연결 설정에 1RTT만 소요된다. TCP hand-shaking 과정을 거치지 않고 TLS 자체를 내포하고 있기 때문에 연결 설정에 필요한 정보와 함께 데이터도 보내버리고, 연결에 성공했으면 수신자는 그 설정을 캐싱해두고 있다가 다음 연결 때 그 캐싱해둔 설정을 사용해 바로 연결을 성립시키기 때문에 0 RTT만으로도 바로 통신이 가능해진다.

## TCP / UDP 의 장단점

|                         | TCP    | UDP                 |
| ----------------------- | ------ | ------------------- |
| 신뢰성                  | 높음   | 낮음                |
| 속도                    | 느림   | 빠름                |
| 전송 방법               | 순차적 | 순서 없이 바로 전달 |
| 오류 감지 및 수정       | 있음   | 없음                |
| 혼잡도 제어 (순서 보장) | 있음   | 없음                |
| 전송 인정(확인)         | 있음   | checksum만          |
